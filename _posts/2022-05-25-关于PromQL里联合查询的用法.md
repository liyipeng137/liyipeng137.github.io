# å…³äºPromQLé‡Œè”åˆæŸ¥è¯¢çš„ç”¨æ³•



å¯¹äºPromQLå¸¸è§çš„sum/rate/topk/irate/delte/countç­‰è¿™äº›çš„ç”¨æ³•ä¸å¿…å¤šè¯´ï¼Œç½‘ä¸Šä¸€æŠ“ä¸€å¤§æŠŠ



çœŸæ­£è®©æˆ‘çº ç»“äº†å¾ˆé•¿æ—¶é—´çš„æ˜¯å…³äºgroup*leftå’Œgroup*rightçš„ç”¨æ³•ï¼Œç½‘ä¸Šèƒ½æ‰¾åˆ°çš„ä»‹ç»å°‘çš„å¯æ€œï¼Œå®˜æ–¹è¯´æ˜æœ‰ä¸€è¯´ä¸€æˆ‘çœ‹ä¸å’‹æ‡‚ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿè¯•äº†å¾ˆå¤šï¼Œçœ‹æ€ä¹ˆç»“åˆå¤šä¸ªä¸åŒæŒ‡æ ‡çš„æ ‡ç­¾ï¼Œå…¶å®æœ‰ç‚¹ç±»ä¼¼sqlçš„å¤šè¡¨æŸ¥è¯¢jion oné‚£æ ·çš„



å¯¹äºgroup*leftå’Œgroup*righté€‚ç”¨çš„æ˜¯ä¸€å¯¹å¤š/å¤šå¯¹ä¸€çš„æƒ…å†µ



æ‰€ä»¥å¾—ç¡®å®šå“ªè¾¹å……å½“å¤šçš„ä¸€æ–¹



## Â 



## ç¤ºä¾‹ä¸€ï¼š



å½“æˆ‘æœ‰ä¸¤ä¸ªæŒ‡æ ‡



æŒ‡æ ‡ä¸€

    kafka_topic_partition_current_offsetÂ Â {partition="0",Â topic="mytopic"}Â Â Â Â Â Â 111
    kafka_topic_partition_current_offsetÂ Â {partition="1",Â topic="mytopic"}Â Â Â Â Â Â 111

æŒ‡æ ‡äºŒ

    kafka_consumergroup_current_offsetÂ  {consumergroup="lyp",Â  partition="0", topic="mytopic"}Â  Â  Â  11
    kafka_consumergroup_current_offsetÂ  {consumergroup="lyp",Â  partition="1", topic="mytopic"}Â  Â  Â  10
    kafka_consumergroup_current_offsetÂ  {consumergroup="lyp002",Â  partition="0", topic="mytopic"}Â  Â  Â  2
    kafka_consumergroup_current_offsetÂ  {consumergroup="lyp002",Â  partition="1", topic="mytopic"}Â  Â  Â  3_

æˆ‘çš„ç›®çš„æ˜¯æ±‚æ‰€æœ‰ Topic å½“å‰æ€»çš„offsetÂ Â  -Â  topic æŸä¸ªæ¶ˆè´¹è€…ç»„çš„offsetÂ Â Â Â 



é‚£æˆ‘ç›´æ¥æŒ‡æ ‡ä¸€å‡å»æŒ‡æ ‡äºŒå¯ä¸å¯ä»¥å‘¢? ä¸è¡Œçš„



å› ä¸ºæŒ‡æ ‡äºŒå¸¦æœ‰æ ‡ç­¾"consumergroup"ï¼Œä¸€ä¸ªtopicå¯¹åº”å¤šä¸ªæ¶ˆè´¹è€…ç»„ï¼Œæ‰€ä»¥æŒ‡æ ‡äºŒçš„æ•°é‡è‚¯å®šæ˜¯æ¯”æŒ‡æ ‡ä¸€å¤šçš„ï¼Œç›´æ¥ç›¸å‡è‚¯å®šæŠ¥é”™ï¼Œè¿™ç§å°±æ˜¯ä¸€å¯¹å¤šçš„æƒ…å†µ



> ç”¨group\_rightè¡¨ç¤ºå³è¾¹å……å½“å¤šçš„è§’è‰²



ä¸€å¯¹å¤šä¼šæŠŠå°‘çš„é‚£è¾¹"æ‰©å……"åˆ°å¤šçš„é‚£è¾¹çš„æ•°é‡ï¼Œè¿”å›çš„æ•°é‡æ˜¯å¤šçš„é‚£è¾¹çš„æ•°é‡

è‡³äºignoring å’Œ onÂ  ,ignoringçš„æ˜¯ä¸¤è¾¹ä¸ä¸€è‡´çš„æ ‡ç­¾ï¼Œonçš„æ˜¯ä¸¤è¾¹ä¸€è‡´çš„æ ‡ç­¾ï¼Œç»“æœæ˜¯ä¸€æ ·çš„



### è¯­å¥

`sum(kafka_topic_partition_current_offset) by (topic) - ignoring(consumergroup) group_right sum(kafka_consumergroup_current_offset) by (topic,consumergroup)`

æ³¨æ„è¿™é‡Œignoringçš„æ˜¯å·¦è¾¹æ²¡æœ‰å³è¾¹æœ‰çš„æ ‡ç­¾



### ç»“æœ

    {topic="mytopic",consumergroup="lyp"}Â  Â  Â  Â  (111+111)-(11+10)
    {topic="mytopic",consumergroup="lyp002"}Â  Â   (111+111)-(2+3)

Â 



## ç¤ºä¾‹äºŒï¼š



å½“æˆ‘æœ‰ä¸¤ä¸ªæŒ‡æ ‡



æŒ‡æ ‡ä¸€

    aliyun_acs_ecs_dashboard_diskusage_utilizationÂ  {device="C:\",Â diskname="C:\",Â instanceId="abaabaaba",Â job="aliyun-exporter",Â userId="xxx"}Â  Â  Â  Â  70
    aliyun_acs_ecs_dashboard_diskusage_utilizationÂ  {device="D:\",Â diskname="D:\",Â instanceId="abaabaaba",Â job="aliyun-exporter",Â userId="xxx"}Â  Â  Â  Â  50

æŒ‡æ ‡äºŒ

    aliyun_meta_ecs_infoÂ  {CreationTime="1999-02-01T00:00Z",Â ExpiredTime="2222-02-01T00:00Z",Â InstanceId="abaabaaba",Â InstanceName="é˜¿å·´é˜¿å·´é˜¿å·´",Â Â job="aliyun-exporter"}Â  Â  Â  Â 1

æˆ‘çš„ç›®çš„æ˜¯æŠŠaliyun\_meta\_ecs\_infoçš„æ ‡ç­¾InstanceNameåŠ åˆ°aliyun\_acs\_ecs\_dashboard\_diskusage\_utilization æŒ‡æ ‡é‡Œï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®æœåŠ¡å™¨åç§°çœ‹å…¶æ‰€æœ‰ç£ç›˜çš„ä½¿ç”¨ç‡



è¿™ä¸ªæ˜¯å¤šå¯¹ä¸€çš„æƒ…å†µï¼Œå¹¶ä¸”aliyun\_meta\_ecs\_info æŒ‡æ ‡çš„ä½œç”¨åªæ˜¯æä¾›æ ‡ç­¾InstanceNameæ–¹ä¾¿ç»“æœæ˜¾ç¤º





### è¯­å¥

    (sum(aliyun_acs_ecs_dashboard_diskusage_utilization)Â  by (instanceId,diskname))Â Â  + on(instanceId)Â  group_left(InstanceName)Â Â Â ( 0*Â  Â label_replace(aliyun_meta_ecs_info,Â "instanceId",Â "$1",Â "InstanceId",Â "(.+)"))



### ç»“æœ

    {Â diskname="C:\",InstanceName="é˜¿å·´é˜¿å·´é˜¿å·´"}Â  Â  70
    {Â diskname="D:\",InstanceName="é˜¿å·´é˜¿å·´é˜¿å·´"}Â  Â  50

Â 



è¿™é‡Œéœ€è¦æ³¨æ„æŒ‡æ ‡ä¸€é‡ŒinstanceIdæ˜¯å°å†™çš„ï¼ŒæŒ‡æ ‡äºŒé‡ŒInstanceIdæ˜¯å¤§å†™çš„ï¼Œæ‰€ä»¥è¿™ä¸ªaliyun-exporterååˆ†æ»´å‘çˆ¹ï¼Œè¿™ä¿©æ˜¯ä¸èƒ½ç›´æ¥å¯¹åº”å¾—ï¼Œéœ€è¦å…ˆç”¨label\_replaceæŠŠInstanceIdæ›¿æ¢æˆinstanceId



åˆç”±äºç›®çš„åªæ˜¯å–aliyun\_meta\_ecs\_infoÂ çš„ä¸€ä¸ªæ ‡ç­¾ï¼Œæ‰€ä»¥éœ€è¦ç”¨0\*aliyun\_meta\_ecs\_infoÂ ç›®çš„æ˜¯ä¸å½±å“ç»“æœ



å…¶å®è¿™é‡ŒæŠŠaliyun\_meta\_ecs\_infoÂ æ”¾å‰é¢ï¼Œç”¨group\_rightç»“æœæ˜¯ä¸€æ ·çš„



Â 



## ç¤ºä¾‹ä¸‰ï¼š



ç»è¿‡ä¸€ç•ªç ”ç©¶



æˆ‘æœ€ç»ˆæäº†ä¸€ä¸ªè¿™ä¹ˆæƒŠå¤©åœ°æ³£é¬¼ç¥çš„PromQL

    (sum(kube_pod_container_resource_requests_cpu_cores{node=~"$node"})Â byÂ (node)Â Â /Â 
    sumÂ (kube_node_status_allocatable_cpu_cores{node=~"$node"})Â Â byÂ (node)Â Â Â *Â 100Â )Â -Â 
    ((sum((sum(kube_pod_status_phase{namespace="default",phase="Failed"}==1)Â byÂ (pod))Â *Â 
    on(podÂ )Â group_rightÂ sum(kube_pod_container_resource_requests_cpu_cores{node=~"$node"})Â byÂ (pod,node)Â Â )Â by(node)Â /
    sumÂ (kube_node_status_allocatable_cpu_cores{node=~"$node"})Â Â byÂ (node))Â *100)Â Â orÂ 
    sum(kube_pod_container_resource_requests_cpu_cores{node=~"$node"})Â byÂ (node)Â Â /Â 
    sumÂ (kube_node_status_allocatable_cpu_cores{node=~"$node"})Â Â byÂ (node)Â Â Â *Â 100

ç›®çš„æ˜¯è®¡ç®—k8sèŠ‚ç‚¹çš„requestå æ¯”ï¼Œä½†ç”±äºèŠ‚ç‚¹ä¸Šæ—¶ä¸æ—¶æœ‰é©±é€çš„podæ®‹ç•™ä¹Ÿä¼šç®—è¿›å»ï¼Œé‚£å°±ä¸å‡†äº†ï¼Œæ‰€ä»¥éœ€è¦å¯¹æœ‰é©±é€pod çš„èŠ‚ç‚¹è¿›è¡Œè¿‡æ»¤ï¼Œå‡å»å·²é©±é€podçš„requestï¼Œè¿™ä¸€é•¿ä¸²æˆ‘æäº†è€é•¿æ—¶é—´ï¼ˆè™½ç„¶ç›´æ¥åˆ é™¤æ®‹ç•™çš„é©±é€podå°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜äº†ï¼Œä½†ä¸€ç›´æ„Ÿè§‰å¯ä»¥åœ¨PromQLä¸Šè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœç„¶ğŸ˜ƒï¼‰

